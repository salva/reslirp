# Documentation for libslirp

**This documentation has been autogenerated from libslirp.h using ChatGPT**

`libslirp` is a user-space TCP/IP stack designed to emulate network
connectivity for virtual machines, containers, or any isolated
environments. It is often used to provide NAT-based networking and
includes utilities for managing network interfaces, timers, and event
loops.

This document outlines the key components of `libslirp` based on its public API.

---

## **Initialization and Cleanup**

### `Slirp *slirp_new(const SlirpConfig *cfg, const SlirpCb *callbacks, void *opaque)`
- **Description**: Creates a new `Slirp` instance using the specified configuration and callbacks.
- **Parameters**:
  - `cfg`: A pointer to a `SlirpConfig` structure defining the configuration.
  - `callbacks`: A pointer to a `SlirpCb` structure defining the callbacks.
  - `opaque`: Custom user data passed to callbacks.
- **Returns**: A pointer to the created `Slirp` instance, or `NULL` on failure.

### `void slirp_cleanup(Slirp *slirp)`
- **Description**: Frees all resources associated with the given `Slirp` instance.
- **Parameters**:
  - `slirp`: A pointer to the `Slirp` instance to clean up.

---

## **Packet Handling**

### `void slirp_input(Slirp *slirp, const uint8_t *pkt, int pkt_len)`
- **Description**: Passes an incoming packet to `libslirp` for processing.
- **Parameters**:
  - `slirp`: A pointer to the `Slirp` instance.
  - `pkt`: A pointer to the packet data.
  - `pkt_len`: The length of the packet data in bytes.

### `void slirp_pollfds_fill_socket(Slirp *slirp, uint32_t *timeout, SlirpAddPollSocketCb add_poll, void *opaque)`
- **Description**: Populates the file descriptors to be polled for events and adjusts the timeout based on internal timers.
- **Parameters**:
  - `slirp`: A pointer to the `Slirp` instance.
  - `timeout`: Pointer to the timeout value (updated by the function).
  - `add_poll`: Callback for adding pollable file descriptors.
  - `opaque`: Custom user data passed to `add_poll`.

### `void slirp_pollfds_poll(Slirp *slirp, int select_error, SlirpGetREventsCb get_revents, void *opaque)`
- **Description**: Processes events on file descriptors after polling.
- **Parameters**:
  - `slirp`: A pointer to the `Slirp` instance.
  - `select_error`: Non-zero if an error occurred during polling.
  - `get_revents`: Callback to retrieve poll results.
  - `opaque`: Custom user data passed to `get_revents`.

---

## **Timers**

### `typedef void (*SlirpTimerCb)(void *opaque)`
- **Description**: Callback function type for timer events.
- **Parameters**:
  - `opaque`: Custom user data passed to the callback.

### `void slirp_handle_timer(Slirp *slirp, SlirpTimerId id, void *cb_opaque)`
- **Description**: Handles timer expiration for the given `SlirpTimerId`.
- **Parameters**:
  - `slirp`: A pointer to the `Slirp` instance.
  - `id`: The ID of the timer that expired.
  - `cb_opaque`: Custom user data associated with the timer.

---

## **Configuration Structures**

### `struct SlirpConfig`
- **Description**: Defines the configuration parameters for a `Slirp` instance.
- **Fields**:
  - `uint32_t version`: The version of the configuration structure.
  - `int restricted`: Whether to prevent the guest from accessing the Internet.
  - `bool in_enabled`: Whether IPv4 is enabled.
  - `struct in_addr vnetwork`: Virtual network for the guest.
  - `struct in_addr vnetmask`: Mask for the virtual network for the guest.
  - `struct in_addr vhost`: Virtual address for the host exposed to the guest.
  - `bool in6_enabled`: Whether IPv6 is enabled.
  - `struct in6_addr vprefix_addr6`: Virtual IPv6 network for the guest.
  - `uint8_t vprefix_len`: Length of the virtual IPv6 network.
  - `struct in6_addr vhost6`: Virtual IPv6 address for the host.
  - `const char *vhostname`: Hostname exposed to the guest.
  - `const char *tftp_server_name`: TFTP server name exposed to the guest.
  - `const char *tftp_path`: Path of files served by TFTP.
  - `const char *bootfile`: Bootfile name exposed to the guest.
  - `struct in_addr vdhcp_start`: Start of the DHCP range.
  - `struct in_addr vnameserver`: Virtual address for the DNS server exposed to the guest.
  - `struct in6_addr vnameserver6`: Virtual IPv6 address for the DNS server.
  - `const char **vdnssearch`: DNS search names exposed to the guest.
  - `const char *vdomainname`: Domain name exposed to the guest.
  - `size_t if_mtu`: MTU when sending packets to the guest.
  - `size_t if_mru`: MRU when receiving packets from the guest.
  - `bool disable_host_loopback`: Prohibit connecting to 127.0.0.1:*.
  - `bool enable_emu`: Enable experimental emulation features.

### `struct SlirpCb`
- **Description**: Defines callback functions for `Slirp` operations.
- **Fields**:
  - `SlirpWriteCb send_packet`: Callback for sending packets to the host.
  - `void (*guest_error)(const char *msg, void *opaque)`: Callback for reporting errors.
  - `int64_t (*clock_get_ns)(void *opaque)`: Callback to retrieve the virtual clock value in nanoseconds.
  - `void *(*timer_new)(SlirpTimerCb cb, void *cb_opaque, void *opaque)`: Create a new timer.
  - `void (*timer_free)(void *timer, void *opaque)`: Remove and free a timer.
  - `void (*timer_mod)(void *timer, int64_t expire_time, void *opaque)`: Modify a timer's expiration time.
  - `void (*notify)(void *opaque)`: Notify that new events may be processed.
  - `void (*register_poll_socket)(slirp_os_socket socket, void *opaque)`: Register a socket for polling.
  - `void (*unregister_poll_socket)(slirp_os_socket socket, void *opaque)`: Unregister a socket.

---

## **Usage Overview**

1. **Initialize SLiRP**:
   Create a `Slirp` instance using `slirp_new()` with the required configuration and callbacks.

2. **Handle Packets**:
   Pass incoming packets to `slirp_input()` and manage file descriptors using `slirp_pollfds_fill_socket()` and `slirp_pollfds_poll()`.

3. **Timers**:
   Use `slirp_handle_timer()` for managing timer events.

4. **Port Forwarding**:
   Set up port forwarding between the host and guest using `slirp_add_hostfwd()` or `slirp_add_guestfwd()`.

5. **Cleanup**:
   Release all resources with `slirp_cleanup()` when done.

---

This documentation provides a concise overview of `libslirp`. For more details, refer to the implementation in the [libslirp repository](https://gitlab.freedesktop.org/slirp/libslirp).

